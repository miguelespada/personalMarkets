<%= javascript_include_tag "https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=places" %>

<%= simple_form_for(@special_location) do |f| %>
  <%= f.error_notification %>

<div class="container">
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">New Location</h3>
        </div>
        <div class="panel-body">
          <fieldset>
          <div class="form-group">
            <%= f.input :name, { placeholder: "Name" } %>
          </div>
          <div class="form-group">
            <%= f.input :address, { placeholder: "Address" } %>
          </div>
          <div class="form-group">
            <%= f.input :city, { placeholder: "City" } %>
          </div>
          <div class="hidden form-group">
            <%= f.input :latitude %>
          </div>
          <div class="hidden form-group">
            <%= f.input :longitude %>
          </div>
          <div class="form-group">
            <%= f.simple_fields_for :photography do |form_builder| %>
              <%= render 'photos/form', f: form_builder, required: true %>
            <% end %>
          </div>
          <div class="form-group">
            <%= render "markets/shared/utils/mapsmall" %>
          </div>
          <div class="form-group col-md-4 col-md-offset-4">
            <%= f.button :submit, class:"btn btn-info" %>
          </div>
          </fieldset>
        </div>
      </div>
    </div>
  </div>
</div>
<% end %>

<script>
$( document ).ready(function() {
  initializeAutocomplete("special_location_city");
  $('.attachinary-input').attachinary();
  $('#hotspot-address').blur(function () {
    updateLocationData();
  });
});

var initializeAutocomplete = function(input_id) {
  autocomplete = new google.maps.places.Autocomplete(
    (document.getElementById(input_id)),
    {
      types: ['(cities)']
    });
  
  google.maps.event.addListener(autocomplete, 'place_changed', function() {
    updateLocationData();
  });
};

var updateLocationData = function(){
  if (addressAndCityAreFilled())
    getLocationFromAddress(encodeAddressToUrl());
};

var addressAndCityAreFilled = function(){
  return $('#special_location_address').val() && $('#special_location_city').val();
};

var encodeAddressToUrl = function(){
  var encodedAddress = encodeURIComponent($('#special_location_address').val());
  var encodedCity = encodeURIComponent($('#special_location_city').val());
  var addressUrl = "https://maps.googleapis.com/maps/api/geocode/json?address=" + encodedAddress + "%20" + encodedCity + "&sensor=false&key=AIzaSyBkhXw8kMql7c4tc1LwaMGbm9024z03AKU";
  return addressUrl;
};

var getLocationFromAddress = function(url){
  var lat, lng;
  $.getJSON(url, function(data){
    lat = data.results[0].geometry.location.lat;
    lng = data.results[0].geometry.location.lng;
    $("#special_location_latitude").val(lat);
    $("#special_location_longitude").val(lng);
    if (PM.marker) {
      PM.map.removeLayer(PM.marker);
    }
    PM.addMarker([lat, lng], false);
    PM.map.setView([lat, lng], 14);
  });
};
</script>