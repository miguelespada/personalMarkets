<script type="text/javascript">
  var PAYMILL_PUBLIC_KEY = "758157067538c48cb45513991681ca78";
</script>

<div class = "home_gallery_title"><i class="fa fa-credit-card fa-2x"></i> <br/>Buy Coupon</div>

<div class="container">
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Coupon Payment</h3>
          <p class="payment-errors"></p>
        </div>
        <div class="panel-body">
          <fieldset>
          <div class="form-group">
          <%= form_tag({controller: "coupons", action: "buy"}, method: "post", id: "new_payment") do %>
          <%= hidden_field_tag "paymill_card_token" %>
          <%= hidden_field_tag "id", "#{coupon_payment.coupon.id}" %>
          <%= hidden_field_tag "total_price", "#{coupon_payment.total_price}" %>
          <%= hidden_field_tag "quantity", "#{coupon_payment.quantity}" %>

          <%= text_field_tag "name", nil, placeholder: "Card name"  %>
          <%= text_field_tag "card_number", nil, placeholder: "Card number" %>
          </div>
          <div class="form-group">
          <%= text_field_tag "expiration_month", nil, placeholder: "Expiration month" %>
          <%= text_field_tag "expiration_year", nil, placeholder: "Expiration year" %>
          <%= text_field_tag "cvc", nil, placeholder: "CVC" %>
          <% end %>
          </div>
          <div class="form-group col-md-4 col-md-offset-4">
            <button class="get-token btn btn-info">Pay</button>
          </div>
          </fieldset>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript" src="https://bridge.paymill.com/"></script>
<script type="text/javascript">
      jQuery(document).ready(function ($) {

          var displayError = function(whatHappened){
            $('#messages').html("");
            $('#messages').append('<div id="error" class="alert alert-danger flash">' + whatHappened + '</div>');
          };

          function PaymillResponseHandler(error, result) {
              if (error) {
                displayError(error.apierror);
              } else {
                  $(".payment-errors").css("display","none");
                  $(".payment-errors").text("");

                  var token = result.token;
                  $('#paymill_card_token').val(token);
                  $('#new_payment').submit();
              }
              $('.get-token').on('click', submitData);
          }

          var submitData = function (event) {

              $('#messages').html("");
              $('.get-token').off('click');

              if (false == paymill.validateCardNumber($('#card_number').val())) {
                displayError('Invalid card number');
                  $(".get-token").removeAttr("disabled");
                  $('.get-token').on('click', submitData);
                  return false;
              }
              if (false == paymill.validateExpiry($('#expiration_month').val(), $('#expiration_year').val())) {
                displayError('Invalid expiry date');
                  $('.get-token').on('click', submitData);
                  return false;
              }

              if ($('#name').val() == '') {
                displayError('Invalid card holder name');
                  $('.get-token').on('click', submitData);
                  return false;
              }
              var params = {
                  amount_int:     Math.round(<%= coupon_payment.total_price %>),  // E.g. "15" for 0.15 Eur
                  currency:       'EUR',    // ISO 4217 e.g. "EUR"
                  number:         $('#card_number').val(),
                  exp_month:      $('#expiration_month').val(),
                  exp_year:       $('#expiration_year').val(),
                  cvc:            $('#cvc').val(),
                  cardholder:     $('#name').val()
              };

              paymill.createToken(params, PaymillResponseHandler);
              return false;
          };
          $(".get-token").on('click', submitData);
      });
</script>